import{a as w}from"./chunk-MZF3K7CE.js";import"./chunk-FUHT4GF3.js";import{i as Z}from"./chunk-7R4IIRUB.js";import{$d as j,Bb as v,Bc as te,Cb as B,Db as k,Ld as ne,Mb as L,Ob as N,Oe as ae,Pa as d,Za as $,_ as F,a as h,b as x,bb as H,bf as se,d as R,ee as r,fa as Q,ga as Y,ib as C,ic as G,jc as K,kc as W,mb as I,nb as f,nc as X,rb as J,sb as U,tb as b,xc as ee,ze as p}from"./chunk-22J4FPNL.js";function re(o,s){if(o&1&&(I(0,"div",2),v(1),f()),o&2){let e=b();d(),B(e.loadingMessage)}}function le(o,s){if(o&1&&(I(0,"div",6),v(1),f()),o&2){let e=b(2);d(),B(e.calcMessage)}}function de(o,s){if(o&1&&(I(0,"div")(1,"div",9),v(2),L(3,"date"),L(4,"date"),f(),I(5,"div",10),v(6),f()()),o&2){let e=s.$implicit;d(2),k("\u7B97\u51FA\u5B9F\u884C\u65E5: ",e.executedAt!=null&&e.executedAt.toDate?N(3,2,e.executedAt.toDate(),"yyyy/MM/dd HH:mm"):N(4,5,e.executedAt,"yyyy/MM/dd HH:mm"),""),d(4),k("\u793E\u4F1A\u4FDD\u967A\u5BFE\u8C61\u5F93\u696D\u54E1\u4EBA\u6570\uFF1A",e.processed,"")}}function pe(o,s){if(o&1&&(I(0,"div",7),H(1,de,7,8,"div",8),f()),o&2){let e=b(2);d(),C("ngForOf",e.batchRecalculateHistories)}}function ue(o,s){if(o&1){let e=J();I(0,"div")(1,"button",3),U("click",function(){Q(e);let u=b();return Y(u.onBatchRecalculate())}),v(2,"\u4E00\u6589\u7B97\u51FA\u5B9F\u884C"),f(),H(3,le,2,1,"div",4)(4,pe,2,1,"div",5),f()}if(o&2){let e=b();d(),C("disabled",e.isCalculating),d(2),C("ngIf",e.calcMessage),d(),C("ngIf",e.batchRecalculateHistories.length>0)}}var ie=class o{user=null;companies=[];employees=[];offices=[];insurances=[];standards=[];bonuses=[];batchRecalculateHistories=[];firestore=F(ne);auth=F(ee);isCalculating=!1;calcMessage="";isLoading=!0;loadingMessage="\u5F93\u696D\u54E1\u60C5\u5831\u53D6\u5F97\u4E2D\u30FB\u30FB\u30FB";ngOnInit(){return R(this,null,function*(){this.isLoading=!0,this.loadingMessage="\u5F93\u696D\u54E1\u60C5\u5831\u53D6\u5F97\u4E2D\u30FB\u30FB\u30FB";let s=te();if(this.user=s.currentUser,!this.user)return;let e=r(this.firestore,"companies"),l=ae(e,se("createdBy","==",this.user.uid)),u=yield p(l);this.companies=u.docs.map(a=>h({id:a.id},a.data()));for(let a of this.companies){let y=r(this.firestore,"companies",a.id,"employees"),i=(yield p(y)).docs.map(c=>x(h({id:c.id},c.data()),{companyId:a.id}));this.employees.push(...i);let T=r(this.firestore,"companies",a.id,"offices"),E=(yield p(T)).docs.map(c=>x(h({id:c.id},c.data()),{companyId:a.id}));this.offices.push(...E);for(let c of i){let P=r(this.firestore,"companies",a.id,"employees",c.id,"insurances"),m=(yield p(P)).docs.map(t=>x(h({id:t.id},t.data()),{employeeId:c.id,companyId:a.id}));this.insurances.push(...m);let O=r(this.firestore,"companies",a.id,"employees",c.id,"standards"),D=(yield p(O)).docs.map(t=>x(h({id:t.id},t.data()),{employeeId:c.id,companyId:a.id}));this.standards.push(...D);let _=r(this.firestore,"companies",a.id,"employees",c.id,"bonus"),S=(yield p(_)).docs.map(t=>x(h({id:t.id},t.data()),{employeeId:c.id,companyId:a.id}));this.bonuses.push(...S)}}console.log("user:",this.user),console.log("companies:",this.companies),console.log("employees:",this.employees),console.log("offices:",this.offices),console.log("insurances:",this.insurances),console.log("standards:",this.standards),console.log("bonuses:",this.bonuses),yield this.fetchBatchRecalculateHistories(),this.isLoading=!1,this.loadingMessage=""})}fetchBatchRecalculateHistories(){return R(this,null,function*(){this.batchRecalculateHistories=[];for(let s of this.companies){let e=r(this.firestore,"companies",s.id,"batchRecalculateHistory"),u=(yield p(e)).docs.map(a=>x(h({id:a.id},a.data()),{companyName:s.companyName||s.name||""}));u.sort((a,y)=>{let A=a.executedAt?.toDate?a.executedAt.toDate().getTime():a.executedAt?new Date(a.executedAt).getTime():0;return(y.executedAt?.toDate?y.executedAt.toDate().getTime():y.executedAt?new Date(y.executedAt).getTime():0)-A}),this.batchRecalculateHistories.push(...u)}this.batchRecalculateHistories.sort((s,e)=>{let l=s.executedAt?.toDate?s.executedAt.toDate().getTime():s.executedAt?new Date(s.executedAt).getTime():0;return(e.executedAt?.toDate?e.executedAt.toDate().getTime():e.executedAt?new Date(e.executedAt).getTime():0)-l})})}onBatchRecalculate(){return R(this,null,function*(){if(!this.companies.length||!this.employees.length||!this.offices.length){alert("\u30C7\u30FC\u30BF\u304C\u53D6\u5F97\u3067\u304D\u3066\u3044\u307E\u305B\u3093");return}this.isCalculating=!0,this.calcMessage="\u8A08\u7B97\u4E2D\u30FB\u30FB\u30FB";let s=0;for(let e of this.companies){let l=this.employees.filter(i=>i.companyId===e.id&&!i.isLostQualification),u=this.offices.filter(i=>i.companyId===e.id),a=0;for(let i of l){let T=u.find(n=>n.id===i.officesId),z=w.judgeSocialInsuranceRequired({employee:i,office:T,company:e}),E=w.judgeInternationalSocialInsurance(i);if(!z||E===!1)continue;let c=r(this.firestore,"insurance_rates"),P=yield p(c),V=(()=>{let n=new Date,g=n.getFullYear();return n.getMonth()+1>=4?g:g-1})(),m=P.docs.map(n=>n.data()).find(n=>n.prefecture===T?.officePrefecture&&String(n.year)===String(V))||null;if(!m)continue;let O=r(this.firestore,"companies",e.id,"employees",i.id,"standards"),D=(yield p(O)).docs.map(n=>h({id:n.id},n.data())),_=D.length>0?D.sort((n,g)=>{let q=n.createdAt?.toDate?n.createdAt.toDate().getTime():n.createdAt?new Date(n.createdAt).getTime():0;return(g.createdAt?.toDate?g.createdAt.toDate().getTime():g.createdAt?new Date(g.createdAt).getTime():0)-q})[0]:null;if(!_)continue;let M=_.kenpoStandardMonthly??i.stdSalaryHealth,S=_.nenkinStandardMonthly??i.stdSalaryPension,t={standardId:_.id,employeeId:i.id,createdAt:new Date,memo:"\u4E00\u6589\u7B97\u51FA"};if(w.judgeHealthInsurance(i)){let n=M&&m.health_insurance?Math.round(M*m.health_insurance):0;t.healthInsuranceTotal=n,t.healthInsuranceCompany=Math.floor(n/2),t.healthInsuranceEmployee=n-t.healthInsuranceCompany}if(w.judgeCareInsurance(i)){let n=M&&m.care_insurance?Math.round(M*m.care_insurance):0;t.careInsuranceTotal=n,t.careInsuranceCompany=Math.floor(n/2),t.careInsuranceEmployee=n-t.careInsuranceCompany}if(w.judgePensionInsurance(i)){let n=S&&m.pension_insurance?Math.round(S*m.pension_insurance):0;t.pensionInsuranceTotal=n,t.pensionInsuranceCompany=Math.floor(n/2),t.pensionInsuranceEmployee=n-t.pensionInsuranceCompany}t.total=(t.healthInsuranceTotal||0)+(t.careInsuranceTotal||0)+(t.pensionInsuranceTotal||0),t.totalCompany=(t.healthInsuranceCompany||0)+(t.careInsuranceCompany||0)+(t.pensionInsuranceCompany||0),t.totalEmployee=(t.healthInsuranceEmployee||0)+(t.careInsuranceEmployee||0)+(t.pensionInsuranceEmployee||0);let ce=r(this.firestore,"companies",e.id,"employees",i.id,"insurances");yield j(ce,t),s++,a++}let y=new Date,A=r(this.firestore,"companies",e.id,"batchRecalculateHistory");yield j(A,{companyId:e.id,processed:a,executedAt:new Date})}this.isCalculating=!1,this.calcMessage="\u8A08\u7B97\u304C\u5B8C\u4E86\u3057\u307E\u3057\u305F\u3002",yield this.fetchBatchRecalculateHistories(),alert(`\u4E00\u6589\u8A08\u7B97\u304C\u5B8C\u4E86\u3057\u307E\u3057\u305F\uFF08${s}\u4EF6\u4FDD\u5B58\uFF09`),setTimeout(()=>{window.location.href="/employee-list"},100)})}static \u0275fac=function(e){return new(e||o)};static \u0275cmp=$({type:o,selectors:[["app-recalculate"]],decls:2,vars:2,consts:[["class","loading-message",4,"ngIf"],[4,"ngIf"],[1,"loading-message"],["type","button",1,"recalc-btn",3,"click","disabled"],["class","calc-message",4,"ngIf"],["class","batch-recalc-history-list",4,"ngIf"],[1,"calc-message"],[1,"batch-recalc-history-list"],[4,"ngFor","ngForOf"],[1,"history-title"],[1,"history-info"]],template:function(e,l){e&1&&H(0,re,2,1,"div",0)(1,ue,5,3,"div",1),e&2&&(C("ngIf",l.isLoading),d(),C("ngIf",!l.isLoading))},dependencies:[X,G,K,W,Z],styles:[".recalc-btn[_ngcontent-%COMP%]{display:block;margin:70px auto 0;background:#1976d2;color:#fff;font-size:1.25em;font-weight:700;padding:1em 3em;border:none;border-radius:12px;cursor:pointer;box-shadow:0 4px 16px #1976d21f;transition:background .2s,box-shadow .2s,transform .1s;letter-spacing:.04em}.recalc-btn[_ngcontent-%COMP%]:hover{background:#1565c0;box-shadow:0 6px 24px #1976d22e;transform:translateY(-2px) scale(1.03)}.loading-message[_ngcontent-%COMP%], .calc-message[_ngcontent-%COMP%]{text-align:center;font-size:1.25em;font-weight:700;margin-top:70px}.batch-recalc-history-list[_ngcontent-%COMP%]{margin:24px auto 0;max-width:480px;display:flex;flex-direction:column;gap:16px}.batch-recalc-history-list[_ngcontent-%COMP%] > div[_ngcontent-%COMP%]{background:#f5f7fa;border-radius:10px;box-shadow:0 2px 8px #1976d214;padding:16px 20px 12px;border-left:5px solid #1976d2;font-size:1.08em;transition:box-shadow .2s}.batch-recalc-history-list[_ngcontent-%COMP%] > div[_ngcontent-%COMP%]:hover{box-shadow:0 4px 16px #1976d229}.batch-recalc-history-list[_ngcontent-%COMP%]   .history-title[_ngcontent-%COMP%]{font-weight:700;color:#1976d2;margin-bottom:4px}.batch-recalc-history-list[_ngcontent-%COMP%]   .history-info[_ngcontent-%COMP%]{color:#333;font-size:.98em}"]})};export{ie as RecalculateComponent};
